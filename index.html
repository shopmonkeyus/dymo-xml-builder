<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>DYMO XML Template Builder</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"
			integrity="sha512-8RnEqURPUc5aqFEN04aQEiPlSAdE0jlFS/9iGgUyNtwFnSKCXhmB6ZTNl7LnDtDWKabJIASzXrzD0K+LYexU9g=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closetag.min.js"
			integrity="sha512-XYx5xhl4B5vKNlaRBWh/nlti0+IPM6eT+dSFc3/oc4rERn2DpwbS3q4OblprqqBLXyRSVePKmf+8mHkDLtGZpg=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"
			integrity="sha512-LarNmzVokUmcA7aUDtqZ6oTS+YXmUKzpGdm8DxC46A6AHu+PQiYCUlwEGWidjVYMo/QXZMFMIadZtrkfApYp/g=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/fold/xml-fold.min.js"
			integrity="sha512-3/N6i9E1fOr1I/8Yt3KL9uFeoEcjh3ceFXf83X6vIlElMZEq0LKF1JDYsIJYaZIJeG2YD9TnGCA4KAR2bEbz/w=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/matchtags.min.js"
			integrity="sha512-wZDyiYRCXczD+UFYLUfsEag3MxJW/ev0CZ0rCTPt3Qcwr4J7LZHJM3XWa2VSEI0s3nGUjPmJRFhrPhgr/Z3Auw=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/selection/active-line.min.js"
			integrity="sha512-0sDhEPgX5DsfNcL5ty4kP6tR8H2vPkn40GwA0RYTshkbksURAlsRVnG4ECPPBQh7ZYU6S3rGvp5uhlGQUNrcmA=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<script
			src="https://cdn.jsdelivr.net/gh/vkiryukhin/vkBeautify@master/vkbeautify.js"
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.2/codemirror.min.css"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
			integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		/>
		<style type="text/tailwindcss">
			.CodeMirror {
				@apply w-full h-full text-xs bg-gray-100;
			}

			.CodeMirror-activeline-background,
			.CodeMirror-activeline-gutter {
				@apply bg-gray-200 !important;
			}
		</style>
		<script type="text/javascript">
			let editor = undefined;

			const onPageLoad = () => {
				dymo.label.framework.init(onSdkLoad);

				editor = CodeMirror(document.getElementById("template"), {
					autoCloseTags: true,
					extraKeys: {
						"Cmd-S": (cm) => onSave(cm),
						"Ctrl-S": (cm) => onSave(cm),
					},
					lineNumbers: true,
					lineWrapping: true,
					matchBrackets: true,
					matchTags: true,
					mode: {
						name: "xml",
						htmlMode: false,
					},
					styleActiveLine: true,
					tabSize: 4,
					theme: "neonsyntax",
					value: `<?xml version="1.0" encoding="utf-8"?>
<DieCutLabel Version="8.0" Units="twips">
    <PaperOrientation>Landscape</PaperOrientation>
    <Id>Address</Id>
    <PaperName>30252 Address</PaperName>
    <DrawCommands>
        <RoundRectangle X="0" Y="0" Width="1581" Height="5040" Rx="270" Ry="270" />
    </DrawCommands>
    <ObjectInfo>
        <AddressObject>
            <Name>Address</Name>
            <ForeColor Alpha="255" Red="0" Green="0" Blue="0" />
            <BackColor Alpha="0" Red="255" Green="255" Blue="255" />
            <LinkedObjectName />
            <Rotation>Rotation0</Rotation>
            <IsMirrored>False</IsMirrored>
            <IsVariable>True</IsVariable>
            <HorizontalAlignment>Left</HorizontalAlignment>
            <VerticalAlignment>Middle</VerticalAlignment>
            <TextFitMode>ShrinkToFit</TextFitMode>
            <UseFullFontHeight>True</UseFullFontHeight>
            <Verticalized>False</Verticalized>
            <StyledText>
                <Element>
                    <String>Shopmonkey.io</String>
                    <Attributes>
                        <Font Family="Arial" Size="18" Bold="False" Italic="False" Underline="False" Strikeout="False" />
                        <ForeColor Alpha="255" Red="0" Green="0" Blue="0" />
                    </Attributes>
                </Element>
            </StyledText>
            <ShowBarcodeFor9DigitZipOnly>False</ShowBarcodeFor9DigitZipOnly>
            <BarcodePosition>AboveAddress</BarcodePosition>
            <LineFonts>
                <Font Family="Arial" Size="12" Bold="False" Italic="False" Underline="False" Strikeout="False" />
                <Font Family="Arial" Size="12" Bold="False" Italic="False" Underline="False" Strikeout="False" />
                <Font Family="Arial" Size="12" Bold="False" Italic="False" Underline="False" Strikeout="False" />
            </LineFonts>
        </AddressObject>
        <Bounds X="332" Y="180" Width="4455" Height="1260" />
    </ObjectInfo>
</DieCutLabel>`,
				});
			};

			const onSdkLoad = () => {
				dymo.label.framework
					.getPrintersAsync()
					.then(function (printers) {
						if (printers.length === 0) {
							document
								.getElementById("errorPrinter")
								.classList.remove("hidden");

							return;
						}

						document
							.getElementById("errorPrinter")
							.classList.add("hidden");

						document.getElementById("printers").innerHTML = "";

						printers.forEach(function (printer) {
							let printerName = printer["name"];

							document.getElementById(
								"printers"
							).innerHTML += `<option value="${printerName}">${printerName}</option>`;
						});
					});

				onPreview();
			};

			const onSave = (cm) => {
				const content = cm.getValue();
				const formatted = vkbeautify.xml(content, 4);
				const cursor = cm.getCursor();

				cm.setValue(formatted);
				cm.setCursor(cursor);

				onPreview();
			};

			const onPreview = () => {
				const label = dymo.label.framework.openLabelXml(
					editor.getValue()
				);

				const valid = label.isValidLabel();

				if (valid) {
					document.getElementById("errorXml").classList.add("hidden");

					const png = label.render(
						"<LabelRenderParams><ShadowDepth>3</ShadowDepth><PngUseDisplayResolution>False</PngUseDisplayResolution></LabelRenderParams>"
					);

					let img = document.getElementById("previewImage");

					if (!img) {
						img = document.createElement("img");
						img.id = "previewImage";
						document.getElementById("preview").appendChild(img);
					}

					img.src = "data:image/png;base64," + png;
				} else {
					document
						.getElementById("errorXml")
						.classList.remove("hidden");
				}
			};

			const onPrint = () => {
				const label = dymo.label.framework.openLabelXml(
					editor.getValue()
				);
				const valid = label.isValidLabel();

				if (valid) {
					label.print(document.getElementById("printers").value);
				} else {
					document
						.getElementById("errorXml")
						.classList.remove("hidden");
				}
			};

			window.addEventListener("load", onPageLoad);
		</script>

		<script src="dymo.connect.framework.js" type="text/javascript"></script>
	</head>

	<body class="flex flex-col gap-4 p-8 text-blue-900 h-screen">
		<h1 class="text-2xl font-bold">DYMO XML Template Builder</h1>

		<div class="h-full flex items-start gap-8">
			<div class="flex flex-col h-full w-1/2 bg-gray-100 rounded">
				<div class="flex items-center justify-between h-16 px-4">
					<h3 class="uppercase font-bold text-sm">Template Code</h3>

					<div class="flex gap-2 items-center">
						<i
							class="fa-solid fa-triangle-exclamation text-red-600 text-lg hidden"
							id="errorXml"
						></i>

						<button
							class="bg-green-900 text-white text-xs font-bold uppercase rounded py-2 px-4 hover:bg-green-800"
							onClick="javascript:onPreview()"
						>
							Preview
						</button>
					</div>
				</div>

				<div id="template" class="h-full w-full"></div>
			</div>

			<div class="h-full w-1/2 bg-blue-100 rounded">
				<div class="flex items-center justify-between h-16 px-4">
					<h3 class="uppercase font-bold text-sm">Preview</h3>

					<div class="flex gap-2 items-center">
						<i
							class="fa-solid fa-triangle-exclamation text-red-600 text-lg hidden"
							id="errorPrinter"
						></i>

						<select
							id="printers"
							class="bg-white rounded text-xs py-2 px-4 appearance-none"
						>
							<option value="" disabled selected>
								Select a printer...
							</option>
						</select>

						<button
							class="bg-green-900 text-white text-xs font-bold uppercase rounded py-2 px-4 hover:bg-green-800"
							onClick="javascript:onPrint()"
						>
							Print
						</button>
					</div>
				</div>

				<div
					class="flex justify-center items-center py-16 px-8 border-t border-blue-200"
					id="preview"
				></div>
			</div>
		</div>
	</body>
</html>
